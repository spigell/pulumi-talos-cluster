name: Run integration tests
on:
  push:
    branches:
      - main
      - preview
  workflow_dispatch:
    inputs:
      test:
        type: choice
        options:
          - TestHcloudClusterGo
          - TestHcloudClusterJS
          - all
        description: "The test to run. Defaults to `all`"
        required: true
        default: 'all'

jobs:
  TestHcloudClusterGo:
    runs-on: ubuntu-latest
    name: The simple GO private cluster
    if: contains(fromJson('["all", "TestHcloudClusterGo"]'), inputs.test) || github.ref == ${{ github.event.repository.default_branch }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
      - name: Prepare pulumi environment
        uses: ./.github/actions/prepare-pulumi-env
        with:
          runtime: go
          with-tests: 'true'
          with-provider: 'false'
      - name: Run the test
        env: 
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: make integration_tests_go TEST=TestHcloudClusterGo
  TestHcloudClusterJS:
    runs-on: ubuntu-latest
    name: The simple GO private cluster
    if: contains(fromJson('["all", "TestHcloudClusterJS"]'), inputs.test) || github.ref == 'refs/heads/main'
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
      - name: Prepare pulumi environment
        uses: ./.github/actions/prepare-pulumi-env
        with:
          runtime: nodejs
          with-tests: 'true'
          with-provider: 'false'
      - name: Run the test
        env: 
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: make integration_tests_go TEST=TestHcloudClusterJS
